<title>load</title>
<script type="module">
	if(window !== parent) {

		navigator.serviceWorker.register("./establisher-sw.js", { scope: `/local/` });

		const
			p_swr = navigator.serviceWorker.ready,
			params = Object.fromEntries(new URLSearchParams(location.search).entries())
		;
			
		self.addEventListener("message", async (...args) => (await p_swr).active.postMessage.apply(null, args), { passive: true });

		switch(params.op) {
			case "open": {
				const
					{ pub } = params,
					sw = (await p_swr).active
				;
				console.log(pub)
				sw.onmessage = ({ data: [msgPort, serverId], source }) => parent.postMessage([msgPort, serverId], [msgPort]);
				sw.postMessage({ code: "OPEN", data: { pub } });
				break;
			}
			case "connect": {
				const
					{ address, destination } = params,
					[name, rand, serverId] = addr.split("-"),
					port = serverIdMap[serverId]?.[`${name}-${rand}`]?.[type]
				;
				parent.postMessage(port, [port]);
				break;
			}
		}
	};
</script>